version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - export NODE_OPTIONS="--max-old-space-size=12288"
            - npm install -g pnpm
            - pnpm install --force
        build:
          commands:
            - pnpm run build
            # Explicitly remove cache and dev folders to reduce artifact size
            - rm -rf .next/cache
            - rm -rf .next/server/pages/api # Remove API routes from static pages if they are causing bloat (optional, checking first)
            - rm -rf .next/trace .next/trace-build
            # Remove heavy build tools from node_modules before any potential inferred bundling
            # Safe cleanup of dependencies (removes devDeps like aws-cdk, esbuild, typescript)
            - pnpm prune --prod
            # Remove heavy runtime dependencies provided by Lambda (save ~60MB)
            - rm -rf node_modules/@aws-sdk
            # Aggressive cleanup of node_modules to ensure only runtime deps remain (if bundled)
            - find node_modules -name "*.d.ts" -delete
            - find node_modules -name "*.map" -delete
            - find node_modules -name "*.md" -delete
            - find node_modules -type d -name "__tests__" -exec rm -rf {} +
            # Debugging: Show size of .next and node_modules after cleanup
            - echo "Final .next size:"
            - du -sh .next
            - echo "Final node_modules size:"
            - du -sh node_modules
      artifacts:
        baseDirectory: .next
        files:
          - "**/*"
      cache:
        paths:
          - .pnpm-store/**/*
    backend:
      phases:
        preBuild:
          commands:
            - export NODE_OPTIONS="--max-old-space-size=12288"
            - export AMPLIFY_CLI_MEMORY_LIMIT=12288
            - export AMPLIFY_CDK_MEMORY_LIMIT=12288
            - npm install -g pnpm
            # Install specific version of esbuild globally
            - npm install -g esbuild@0.25.2
            - rm -rf node_modules
            - rm -rf .pnpm-store
            - pnpm install --force
            # Install same version locally
            - pnpm add -D esbuild@0.25.2
            # Remove any other versions
            - rm -rf node_modules/.pnpm/esbuild@0.23.1
        build:
          commands:
            - export NODE_OPTIONS="--max-old-space-size=12288"
            - export ESBUILD_BINARY_PATH=$(which esbuild)
            - pnpm exec ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
