version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - export NODE_OPTIONS="--max-old-space-size=12288"
            - npm install -g pnpm
            - pnpm install --force
        build:
          commands:
            - pnpm run build
            # Delete development-only directories and cache to reduce artifact size
            - rm -rf .next/cache
            - rm -rf .next/dev
            - rm -rf .next/diagnostics
            - rm -rf .next/turbopack
            - rm -rf .next/trace*
            - rm -rf .next/standalone
            # Delete build-only packages from node_modules (not needed for SSR runtime)
            # These are only needed during CDK deploy (backend) or compilation
            - rm -rf node_modules/aws-cdk-lib
            - rm -rf node_modules/aws-cdk
            - rm -rf node_modules/@aws-cdk
            - rm -rf node_modules/constructs
            - rm -rf node_modules/typescript
            - rm -rf node_modules/esbuild
            - rm -rf node_modules/@esbuild
            - rm -rf node_modules/@swc
            - rm -rf node_modules/.pnpm/aws-cdk-lib*
            - rm -rf node_modules/.pnpm/aws-cdk@*
            - rm -rf node_modules/.pnpm/@aws-cdk*
            - rm -rf node_modules/.pnpm/constructs*
            - rm -rf node_modules/.pnpm/typescript@*
            - rm -rf node_modules/.pnpm/esbuild@*
            - rm -rf node_modules/.pnpm/@esbuild*
            - rm -rf node_modules/.pnpm/@swc*
            # Show size of build output for debugging
            - du -sh .next
            - du -sh .next/* 2>/dev/null || true
            - du -sh node_modules 2>/dev/null || true
      artifacts:
        baseDirectory: .next
        files:
          - "**/*"
      cache:
        paths:
          - .pnpm-store/**/*
    backend:
      phases:
        preBuild:
          commands:
            - export NODE_OPTIONS="--max-old-space-size=12288"
            - export AMPLIFY_CLI_MEMORY_LIMIT=12288
            - export AMPLIFY_CDK_MEMORY_LIMIT=12288
            - npm install -g pnpm
            # Install specific version of esbuild globally
            - npm install -g esbuild@0.25.2
            - rm -rf node_modules
            - rm -rf .pnpm-store
            - pnpm install --force
            # Install same version locally
            - pnpm add -D esbuild@0.25.2
            # Remove any other versions
            - rm -rf node_modules/.pnpm/esbuild@0.23.1
        build:
          commands:
            - export NODE_OPTIONS="--max-old-space-size=12288"
            - export ESBUILD_BINARY_PATH=$(which esbuild)
            - pnpm exec ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
